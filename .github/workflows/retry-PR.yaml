name: 重开拉取请求来重新尝试验证管道

on:
  workflow_dispatch:
    inputs:
      PR:
        description: 需要重试的拉取请求
        required: false
        default: auto
      mode:
        type: choice
        description: 生成模式
        required: true
        default: Release
        options:
          - Release
          - Debug
  schedule: [{ cron: '0 */3 * * *' }]

permissions:
  contents: read

jobs:
  Retry:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.x

      - name: 关闭并重开需要重试的拉取请求
        env:
          # GITHUB_LOGIN 为工作流所在仓库所有者
          GITHUB_LOGIN: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.RETRY_TOKEN }}
        shell: bash
        run: |-
          # 如果 inputs.PR 未指定或为空，则使用 auto 模式
          if [[ -z "${{ inputs.PR }}" || "${{ inputs.PR }}" == "auto" ]]; then
            export PR="auto"
          else
            export PR="specify ${{ inputs.PR }}"
          fi

          dotnet run --project "Retryer/Retryer.csproj" --configuration ${{ inputs.mode }} -- $PR
